# 題組三解題步驟

## 步驟一：將素材目錄複製到崗位目錄下，確認素材內容與抽題題號一致
監評長按下倒數計時後，可以先把桌面上素材目錄中的題目素材複製一份到自己的工作目錄下，這時要確認自己複製的題目和抽到的題目是一致的，之後都在工作目錄下來取用相關的素材，這樣比較不容易出錯；在安裝軟體的準備時間裏，也要確認一下電腦桌面中是否有包含了素材這個目錄，並且四個題組的素材都在其中。

---

## 步驟二：將版型檔案及相關素材複製到網站根目錄下，並進行相應的更名及整理
  1. 開立./css, ./js, ./api, ./icon等常用目錄以利檔案分類及管理
  2. 將素材檔中的.css, .js, 及icon圖檔複製到相應的目錄下
  3. 更改版型素材的相關檔名，以符合解題的需要：
      * 03P01.htm => index.php
      * 03P02.htm => intro.php
      * 03P03.htm => admin.php
  4. 更改版型素材的相關連結及匯入檔內容
      * 修改 `index.php` 中 `<link>` 及 `<script>` 中的連結路徑，指向正確的位置
      * 修改 `./css/css.css` 中的圖片 `url` ，指向根目錄下的 `../icon` 目錄，不過在此題組中，body設定中的 `b.png` 圖檔不存在，所以直接移除這個設定就可以了。
        ```
        body{
            background:url(../icon/b.png); /* 移除這行即可 */
	        font-family:微軟正黑體;
        }
        ```
  5. 開立 `./movie/` 目錄，把素材目錄中的院線片海報及影片檔都先複製過來
  6. 開立 `./poster/` 目錄，把素材目錄中的預告片海報都先複製過來
  7. 以上兩個步驟是為了方便之後在製作列表和上傳檔案功能時，可以減少一些功夫，同時我們為了速度考量，並不會對上傳的檔案做更名之類的多餘動作，因此我們在做列表功能時，可以直接指定目錄及檔名來顯示相關的圖片或影片，而不用等到完成上傳檔案的功能後，才一個一個上傳
  8. 開啟 `xampp` 及 `apache` 伺服器，使用 `localhost` 或 `127.0.0.1` 檢視網頁是否正確顯示，css 的載入是否正確

---

## 步驟三：進行前後台的檔案整理及切版，分離出共用的區塊或功能
  1. 建立 `front`及 `admin` 兩個目錄，一個代表前台的相關檔案，一個代表後台的相關檔案，前後台共用的元件則先放在根目錄下，或另開一個 `comm` 目錄用來存放共用的元件。
  2. 在 `index.php` 中找到中間主要內容區的區塊，切出去成為 `home.php` 放在 `./front/` 目錄中。
  3. 在 `intro.php` 中找到中間主要內容區的區塊，排除首尾後成為 `intro.php` 移動到 `./front/` 目錄中。
  4. 在 `admin.php` 中找到中間主要內容區的區塊，保留後台選單的部份，其它的內容切出去成為 `home.php` 放在 `/admin/` 目錄中，不過因為這個 `home.php` 只有一行的內容，所以也可以用 `echo` 的方式寫死在 `admin.php` 中。

```php
//另一個做法參考，省略home.php
  $do=(!empty($_GET['do']))?$_GET['do']:"";
  $path="./admin/".$do.".php";
  if(file_exists($path)){
    include $path;
  }else{
    echo "<h2 class='ct'>請選擇所需功能</h2>";
  }
```

  5. 使用 `include` 指令來重新組合 `index.php` 及 `admin.php` 頁面，並加上判斷式來確保要組合的檔案是存在的。
  6. 以 `get` 的方式來傳遞各頁面要組合的元件內容，比如 `do=login` 表示要看到的是登入頁面，因此在前台的 `include` 中可以併入 `login.php` 來呈現。
  7. 修改 `index.php` 及 `admin.php` 中的連結內容及寫法，確保可以正確的連結到相應的頁面。
  8. 修改 `admin.php` 中的後台功能連結內容，後續的功能會用到。

---

## 步驟四：建立資料庫連線檔及常用函式。
  1. 建立 `base.php` 檔，用來放共用的設定及函式。
  2. 設定好PDO的連線參數 `$pdo=new PDO()`
  3. 啟用session `session_start()`
  4. 建立全域變數或是共用函式
      * find(\$table,...\$arg) - 尋找特定條件的單筆資料或第一筆資料
      * all(\$table,...\$arg) - 取得資料表的全部資料或是特定條件的全部資料
      * nums(\$table,...\$arg) - 計算符合條件的資料筆數
      * save(\$talbe,\$data) - 新增或更新單筆資料
      * del(\$table,...\$arg) - 刪除特定條件的全部資料
      * q(\$sql) - 簡化 \$pdo->query(\$sql)->fetchAll() 的使用;
      * to(\$path) - 簡化 header("location:xxxxxx") 的使用;
  5. 做好以上工作後，可以先建一張簡單的資料表，把資料庫連線及所有自訂函式功能先測試一次，以確保後續使用不會有問題。

---

## 步驟五：建立資料表及預設資料。
每個題組依狀況不同，在這一步有不同的做法，視自己對題目的熟悉程度來做應變，可以一次把全部資料表建完，也可以視解題的進度來逐步建立或修改資料表。
根據題意，題組三會需要用到以下的資料表：
* movie - 院線片資料表
* ord - 訂單資料表
* poster - 預告片資料表

1. 依序建立功能需要的三張資料表:
  * movie

    |   name   |    type    |  pk   | default |  A_I  |   note   |
    | :------: | :--------: | :---: | :-----: | :---: | :------: |
    |    id    |  int(10)   |  yes  |         |  yes  | 流 水 號 |
    |   name   |    text    |       |         |       | 電影名稱 |
    |  level   | tinyint(1) |       |         |       |   分級   |
    |  length  |   int(5)   |       |         |       |   長度   |
    |  ondate  |    date    |       |         |       | 放映日期 |
    | publish  |    text    |       |         |       |  發行商  |
    | director |    text    |       |         |       |   導演   |
    | trailer  |    text    |       |         |       | 預告影片 |
    |  poster  |    text    |       |         |       | 預告海報 |
    |  intro   |    text    |       |         |       | 電影介紹 |
    |   rank   |   int(5)   |       |         |       |   排序   |
    |    sh    |   int(1)   |       |    1    |       |   顯示   |
    
  * ord

    |  name   |  type   |  pk   | default |  A_I  |   note   |
    | :-----: | :-----: | :---: | :-----: | :---: | :------: |
    |   id    | int(10) |  yes  |         |  yes  |  流水號  |
    |   no    |  text   |       |         |       | 訂單編號 |
    |  movie  |  text   |       |         |       | 電影名稱 |
    |  date   |  date   |       |         |       | 觀影日期 |
    | session |  text   |       |         |       |   場次   |
    |   qt    | int(1)  |       |         |       |   票數   |
    |  seat   |  text   |       |         |       |   座位   |

  * poster
  
    |  name  |  type   |  pk   | default |  A_I  |   note   |
    | :----: | :-----: | :---: | :-----: | :---: | :------: |
    |   id   | int(10) |  yes  |         |  yes  |  流水號  |
    | poster |  text   |       |         |       | 檔案路徑 |
    |  name  |  text   |       |         |       |   片名   |
    |  rank  | int(5)  |       |         |       |   排序   |
    |   sh   | int(1)  |       |    1    |       |   顯示   |
    |  ani   | int(1)  |       |    1    |       | 轉場動畫 |

2. 為了解題順利，可以把資料表中的一些欄位設為可接受空值的狀況，這樣即使未設定內容，也能正常新增或更改資料，不過這個做法只是為了先求解題完成而做的取巧，實務上應該根據需求及功能來決定欄位是否可以接受空值，並在程式端檢查來源資料是否為空值

---

## 步驟六：管理登入
題組三的管理登入算是簡單的功能，並不需要有個管理者的資料表來做紀錄，因此這邊只要直接寫死帳密做檢查即可；另外，雖然題目中沒有提到，但為了避免每次要到後台時都要再一次輸入帳號密碼，這邊建議還是建一個session變數來紀錄登入的狀態：
1. 在 `admin.php` 撰寫以session為判斷的登入程式，如果己經登入則可以選擇後台功能，如果未登入，則顯示登入表單。
2. 因為會使用到session，所以記得要先在 `admin.php` 的最前面 include `base.php` 來啟用session的功能
3. 撰寫登入判斷程式，帳號依題意寫死即可(帳號:admin,密碼:1234)
4. 這邊要注意的是在未登入的狀況下，只顯示登入表單而己，後台的功能選單在未登入時是不顯示的。
5. 由於素材提供的版型配色和字型等內容與題目的示意圖落差極大，因此題組三我們不太管示意圖的視覺配置了，只要功能符合就可以。
6. 修改 `admin.php` 中的內容區域寬度，方便後續的程式撰寫
```html
    <div class="rb tab" style="width:98%">
      <!---功能內容----->
    </div>
```
7. 這邊要小心判斷式中包含的html區段，避免漏了tag沒包到造成版面出錯

---

## 步䮕七：後台預告片海報管理一
示意圖給的做法是把新增和管理都做在同一個畫面中，我們也採用一樣的畫面配置，但是美化先不考量；

另外，示意圖中並沒有給出轉場動畫的設定方式為何，因此要採用全區設定也可以，我這邊使用的做法是每個海報都可以單獨設定一個轉場動畫。

最後，示意圖中給出的排序方式是採用按鈕往上或往下來改變順序，但依照題意只要可以設定排序都可以，因此這邊的做法也可以採用直接填入數值的方式來達到排序的目的，我這邊使用的是ajax的方式以按鈕動作來改變排序。

1. 在 `./admin/` 中建立 `poster.php` 
2. 撰寫**新增預告片海報**的表單。
3. 在 `./api/` 目錄中建立 `addposter.php`，並撰寫新增預告片寫入資料表的相關程式
4. 撰寫**預告片清單**中的表單格式及區塊配置
5. 在 `./admin/` 中建立 `posterlist.php` ，這個檔案的用途是做為海報列表之用，並透過Ajax的方式被引入到 `poster.php`
6. 在 `posterlist.php` 中撰寫預告片海報列表的程式碼，由於會使用到排序的功能，因此要注意在取出資料時，要下 ` order by rank`的指令，才會依照rank欄位值來排序。
7. 在 `poster.php` 中增加javascript 程式來載入 `posterlist.php` 的內容
8. 建立 `./api/editposter.php` 檔案並撰寫海報的編輯片名/顯示/刪除/動畫等功能

---

## 步驟八：後台預告片海報管理二
這邊我們來處理排序的問題，題目要求要可以設定順序，但沒有說明設定的方式，因此有兩個方向可以製作，一個是提供一個調整順序的輸入框，直接輸入對應的順序，然後在步驟七中修改一下相應的頁面內容及api即可；這邊示範的是示意圖中的以按鈕的方式來調整順序的做法，我們利用ajax的方式來完成這個功能。

不管採用那個做法，後面在院線片管理中也會使用到改變順序的功能，因此只要做一次就可以複製給另一個功能來使用。

1. 在 `./admin/posterlist.php` 中的按鈕標籤中增加資料的id值，這裹我們利用foreach迴圈的特性，同時計算出上一筆及下一筆的id值，然後帶入按鈕屬性中的id值。
2. 在 `./admin/poster.php` 中原本的 `getList()` 函式中建立載入 `posterlist.php` 後的按鈕點擊事件，並取得要交換的兩筆資料id，送到後台api去做順序對調的動作
3. 在 `./api/switch.php` 中撰寫交換資料排序的php程式碼
4. 由於排序的交換功能在院線片中也會使用到，因此我們在設計api時增加了對資料表的判斷，做到可以相容各資料表
5. 在ajax傳送完資料後，會重新載入 `posterlist.php` 這時會產生新的排序後的列表。

---

## 步驟九：後台院線片管理一
院線片管理的功能分成三個部份來處理：
  1. 首先是資料的手動增加及列表功能；
  2. 再來是處理院線片的刪除/顯示/排序功能；
  3. 最後是新增/編輯院線片的功能；

之所以會這樣安排是因為新增/編輯的表單欄位較多又有上傳檔案的功能，會花比較多時間來製作，加上分數只有十分，所以我個人都會先跳過這兩個小功能，先把佔分比較多且製作可以較快速的列表及按鈕功能做完再回頭來補，這樣的解題策略因人而異，同學們可以自行安排。
1. 在 `./admin/` 目錄中新增 `movie.php` 檔案，這是院線片管理的主要頁面。
2. 由於題目沒有提供院線片的文字素材，因此我們可以先建立一個 `tmp.php` 自行寫一支小程式來快速建立需要的資料內容，執行完畢後資料表就會產生一堆院線片的資料，之後這個 `tmp.php` 檔可以刪除；除了寫程式的方式，也可以直接利用phpmyadmin來新增及複製數筆資料。

```php

include "base.php";

for($i=1;$i<=10;$i++){
    $data['level']=rand(1,4);
    $data['name']="院線片".$i;
    $data['length']=90;
    $data['ondate']=date("Y-m-d",strtotime("+".(($i-2)%5)." days"));
    $data['publish']="發行商".$i;
    $data['director']="導演".$i;
    $data['trailer']="03B".sprintf("%02d",$i)."v.mp4";
    $data['poster']="03B".sprintf("%02d",$i).".png";
    $data['intro']="院線片".$i."的劇情簡介"."院線片".$i."的劇情簡介"."院線片".$i."的劇情簡介"."院線片".$i."的劇情簡介"."院線片".$i."的劇情簡介"."院線片".$i."的劇情簡介";
    $data['rank']=$i;
    $data['sh']=1;
    save("movie",$data);
  }

```

3. 透過2.的資料新增，我們不用先做新增院線片的功能也可以建置資料，因此接下來我們在 `./admin/movie.php` 中撰寫院線片管理需要的頁面html碼
4. 在 `./admin/` 目錄中新增 `movielist.php` 檔案，作用和 `posterlist.php` 一樣，是用來以ajax載入列表之用。
5. 在 `./admin/movielist.php` 撰寫電影列表的相關程式碼。
6. 在 `base.php` 中增加一個分級的陣列，這個陣列以我們在資料庫中設定的分級種類做為key值，而內容則以子陣列的方式存入分級圖檔的檔名及字串，加在 `base.php` 中的原因是要這個變數成為所有頁面都可以存取的變數

```php
//建立一個分級資訊的陣列，儲存分級的icon檔名及分級的字串
$level=[
         1 => ["03C01.png","普遍級"],
         2 => ["03C02.png","輔導級"],
         3 => ["03C03.png","保護級"],
         4 => ["03C04.png","限制級"],
       ];
```

7. 在 **新增電影** 、 **編輯電影** 按鈕中增加js的跳頁功能及帶入需要的參數，讓頁面可以跳到對應的功能頁面去。
8. 對於按鈕的大小和外形實在無法忍受的話，可以到 `./css/css.css` 進行修改和調整，讓按鈕的外形看起來順眼一點，但這不做也不影響分數。

```css
input[type='button'],input[type='submit'],input[type='reset'],button,.button
{
	min-width:40px; /*最小高度和寬度可以縮小一些*/
	min-height:20px;
	background:#000;
	color:#fff;
	border:none;
	cursor:pointer;
	font-size:14px; /*字型可以改小*/
	text-decoration:none;
	margin:3px 6px; /*增加上下左右的邊距*/
	border-radius:5px; /*增加點圓角*/
}
```

---

## 步驟十：後台院線片管理二
完成列表功能後，接下來製作各個按鈕的功能，示意圖中不像預告片那邊有一個確認編輯的按鈕，因此我們可以理解為每部院線片的設定都是獨立的，但是題目本身並沒有指定到底要怎麼做，因此延用預告片的做法也是可以的，我在這邊使用的是接近示意圖的做法，也就是儘可能使用ajax來完成所有按鈕功能的操作，每一次的操作也只針對一筆資料來處理。

1. **顯示**按鈕的功能，需要告知api是那張表格的那筆資料要改為隱藏，因此我們在 `./admin/movielist.php` 的顯示按鈕中增加一個**data-show**屬性並帶入資料的id值
2. 在 `./admin/movie.php` 中撰寫javascript程式嗎，處理顯示按鈕的功能
3. 建立 `./api/sh.php` 並撰寫更改顯示值的語法
4. **往上**、**往下**按鈕的功能，複製 `./admin/poster.php` 中的排序按鈕js，並修改相應的資料表名，即可完成排序的功能，要記得在 `./admin/movielist.php` 中增加排序的sql語法，api還是使用 `./api/switch.php` ，只要記得帶上table名就可以了
5. **刪除**按鈕的功能，在 `./admin/movielist.php` 的刪除按鈕上增加**data-del**屬性並帶入資料的id值
6. 在 `./admin/movie.php` 中增加刪除功能的事件註冊及相應的行為
7. 新增 `./api/del.php` ，並撰寫刪除功能的程式碼

---

## 步驟十一：後台院線片管理三-新增/編輯院線片
示意圖給出的表單範例做起來有點囉嗦，所以這邊建議先把功能完成，回頭有空再來處理視覺的問題，而且因為這兩個功能加起來只有10分，如果不能在15分鐘內完成的話，實在不值得花太多時間在這裹，我這邊使用的做法先不管美觀和排版，先以縮短這兩個小項目的製作時間為主，如果沒有把握可以把兩個項目快速做完，會建議先去處理其它的功能再回頭來補完這兩個項目。

1. 在 `./admin/` 目錄下新增 `addmovie.php` 檔案，並撰寫需要的表單內容，示意圖中左側的"影片資料"及"劇情簡介"兩個字串並不是必須的，排列方式以簡單快速為主，這邊我使用 `ul` 清單加上emmet語法來列出所有的表單項目，再加上簡單的css控制一下外觀。
2. 在 `./api/` 目錄下新增 `editmovie.php` 檔案，並撰寫需要的PHP程式碼，這邊我們增加對id的判斷來讓這個程式可以同時處理新增及編輯功能。
3. 依題意最麻煩的是上映日期規定要使用三個下拉選單，但資料表中只有一個**ondate**欄位，因此要在api中將這三個欄位組合成日期格式後才能存入資料表。
4. 由於表單提供使用者可以上傳海報及影片，所以要記得做兩個判斷式來處理檔案上傳的動作
5. 另外要記得處理排序欄位及顯示欄位，排序欄位的值我們以sql語法直接向資料尋找id的最大值再加1來當成rank欄位的值
6. 複製 `./admin/addmovie.php` 成為 `./admin/editmovie.php` ，並加入取得資料及在各欄位寫入欄位值。

---

## 步驟十二：前台院線片清單製作
題組三的三個前台功能中，院線片清單算是簡單的，主要就是照題意來列出四部院線片再加上分頁功能就可以了；

但是由於素材提供的css樣式和題目的不一樣，所以在這很容易就造成版面過擠不好看，但美觀的事可以晚點再做，我們先把功能完成，再回頭修一下 CSS 即可。

1. 先在 `index.php` 的最上頭引入 `base.php` 檔
2. 可以在前台顯示的院線片有以下條件：
   * 在後台管理中被設為 **顯示** 的影片
   * 上映日起算的三天日期在觀影日內
3. 刪除原本的 **table** 標籤區段，由於版型css已經不一樣了，使用表格來做排版反而麻煩，因此這邊我們建立一個新的容器，並使用flex及自己定義的css來做版面的簡單設定
4. 由於我們在 `base.php` 中並沒有對 `&&` 以外的條件做設計，因此這邊無法使用 **all()** 函式來取出所有符合條件的資料，我們使用 **q()** 函式來直接寫入SQL語法並取得符合條件的所有資料
5. 建立分頁需要的各項變數，並將 **limit** 語法寫入SQL語法中
```php
//取得符合條件的資料語法
    $today=date("Y-m-d"); //今天的日期字串
    $startDay=date("Y-m-d",strtotime("-2 days"));  //距離今天兩天前的日期字串
    ...
      分頁需要的各項變數
    ...

    //取得今天可觀看的影片資料
    $movies=q("select * 
                 from movie 
                where sh=1 && 
                      ondate >='$startDay' && 
                      ondate <='$toDay' 
                order by rank
                limit $start,$div ";
              );
    
  //另一種取得日期區間的SQL語法  
    $movies=q("select * 
                 from movie 
                where sh=1 && 
                      ondate between '$startDay' AND '$today'
                order by rank
                limit $start,$div ";"
              );
```
6. 利用迴圈將題意所需的圖片，資訊及連結分頁輸出至頁面上 
7. 撰寫基本的css來控制畫面的呈現，不用寫得太複雜太漂亮，能看就好，主要調整的是圖片的大小，位置排列的關係，字形大小，我會使用flex來做控制
8. 最後處理劇情簡介頁面，也就是在 `./front/intro.php` 中撰寫讀出資料的相關語法，並把資料放在對應的位置中，原始提供的版型有可能會造成奇怪的斷行或位置不太正確的狀況，這些問題可以晚點再處理，這邊只要先確認功能是正常的，影片可以播放就好了。
